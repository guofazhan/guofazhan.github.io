<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Eureka之远程通讯模块 · Mr.G-博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Eureka之远程通讯模块 - Mr.G"><meta name="keywords"><meta name="author" content="Mr.G"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://guofazhan.github.io/atom.xml" title="Mr.G-博客"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Eureka之远程通讯模块</h1><div class="post-info">2018-08-25<!-- p.visit--><!--    if (is_home())--><!--        i(data-hk-page='http://bubuzou.com'+url_for(item.path)) ---><!--    else--><!--        i(data-hk-page="current") ---><!--   span 次访问--></div><div class="post-content"><blockquote>
<p>Eureka 架构为C-S模式 同时支持S 集群 ，不可避免的在client-server、server-server之间是需要远程通讯的，上面已经知道，Eureka 提供是http协议rest api，下面通过源码源码分析学习下eureka 提供的远程通讯模块</p>
</blockquote>
<h4 id="提供远程通讯模块的包路径"><a href="#提供远程通讯模块的包路径" class="headerlink" title="提供远程通讯模块的包路径"></a>提供远程通讯模块的包路径</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.discovery.shared.transport</span><br></pre></td></tr></table></figure>
<h4 id="通讯模块对外的核心接口矩阵"><a href="#通讯模块对外的核心接口矩阵" class="headerlink" title="通讯模块对外的核心接口矩阵"></a>通讯模块对外的核心接口矩阵</h4><p><img src="https://github.com/guofazhan/image/blob/master/%E9%80%9A%E8%AE%AF%E6%A0%B8%E5%BF%83%E6%8E%A5%E5%8F%A3.png?raw=true" alt="image"></p>
<blockquote>
<ol>
<li>EurekaHttpClient 通讯请求接口，负责发送http请求</li>
<li>EurekaHttpClientFactory EurekaHttpClient创建工厂接口，负责创建高等级的client</li>
<li>TransportClientFactory EurekaHttpClient创建工厂接口，负责创建低等级的client</li>
<li>EurekaTransportConfig 通讯相关配置获取接口，负责在配置文件中读取通讯模块的配置信息</li>
</ol>
</blockquote>
<blockquote>
<p><strong>备注：</strong> EurekaHttpClientFactory与TransportClientFactory同样都是创建client工厂，不过两个的职责不一样，client按功能划分为两大类，下面详细介绍。<br><a id="more"></a></p>
</blockquote>
<h4 id="EurekaHttpClient"><a href="#EurekaHttpClient" class="headerlink" title="EurekaHttpClient"></a>EurekaHttpClient</h4><p><img src="https://github.com/guofazhan/image/blob/master/EurekaHttpClient.png?raw=true" alt="image"></p>
<blockquote>
<p>通过上图可以明确的看出EurekaHttpClient接口实现为两大类:</p>
<ol>
<li>实现http通讯的lowlevel实现；</li>
<li>使用装饰器模式实现特定功能的top level实现 。</li>
</ol>
</blockquote>
<blockquote>
<p>low level实现：  Eureka 根据http client 实现了两个AbstractJerseyEurekaHttpClient与AbstractJersey2EurekaHttpClient的low level 实现。从上面可以看出，如果Jersey1与Jersey2都不满足我们的自己的需求的话，我也可以根据自己需要的httpClient实现替代类，例如实现以OKhttp作为底层通讯的OkHttpEurekaHttpClient 或实现以netty作为底层通讯的NettyEurekaHttpClient，</p>
</blockquote>
<blockquote>
<p>top level实现 ： 通过装饰器模式eueka 内置了 响应指标采集功能的装饰器、失败重试功能装饰器等，同时我们也可以扩展。</p>
</blockquote>
<blockquote>
<p><strong> 备注：</strong> HttpReplicationClient是eureka 专为server端集群节点通讯提供的通讯接口。其本质low level</p>
</blockquote>
<ul>
<li>EurekaHttpClient接口方法</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>register(InstanceInfo info)</td>
<td>服务注册</td>
</tr>
<tr>
<td>cancel(String appName, String id)</td>
<td>服务下线</td>
</tr>
<tr>
<td>sendHeartBeat</td>
<td>服务续约</td>
</tr>
<tr>
<td>statusUpdate</td>
<td>服务状态更新</td>
</tr>
<tr>
<td>deleteStatusOverride</td>
<td></td>
</tr>
<tr>
<td>getApplications(String… regions)</td>
<td>获取服务注册列表</td>
</tr>
<tr>
<td>getDelta(String… regions)</td>
<td>获取增量列表</td>
</tr>
<tr>
<td>getVip(String vipAddress, String… regions)</td>
<td>根据vip获取列表</td>
</tr>
<tr>
<td>getSecureVip(String secureVipAddress, String… regions)</td>
<td>根据svip获取列表</td>
</tr>
<tr>
<td>getApplication(String appName)</td>
<td>根据集群ID获取服务集群列表</td>
</tr>
<tr>
<td>getInstance(String appName, String id)</td>
<td>根据集群ID与服务ID获取服务</td>
</tr>
<tr>
<td>getInstance(String id)</td>
<td>根据服务ID获取服务</td>
</tr>
</tbody>
</table>
<ul>
<li>HttpReplicationClient接口方法 (server 节点数据同步特有)</li>
</ul>
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>statusUpdate(String asgName, ASGStatus newStatus)</td>
<td>状态更新同步</td>
</tr>
<tr>
<td>submitBatchUpdates(ReplicationList replicationList)</td>
<td>批量执行更新同步任务</td>
</tr>
</tbody>
</table>
<h4 id="EurekaTransportConfig通讯配置新获取"><a href="#EurekaTransportConfig通讯配置新获取" class="headerlink" title="EurekaTransportConfig通讯配置新获取"></a>EurekaTransportConfig通讯配置新获取</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * eureka 远程通讯客户端配置默认实现</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> David Liu</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEurekaTransportConfig</span> <span class="keyword">implements</span> <span class="title">EurekaTransportConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SUB_NAMESPACE = TRANSPORT_CONFIG_SUB_NAMESPACE + <span class="string">"."</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String namespace;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DynamicPropertyFactory configInstance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultEurekaTransportConfig</span><span class="params">(String parentNamespace, DynamicPropertyFactory configInstance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.namespace = parentNamespace == <span class="keyword">null</span></span><br><span class="line">                ? SUB_NAMESPACE</span><br><span class="line">                : (parentNamespace.endsWith(<span class="string">"."</span>)</span><br><span class="line">                    ? parentNamespace + SUB_NAMESPACE</span><br><span class="line">                    : parentNamespace + <span class="string">"."</span> + SUB_NAMESPACE);</span><br><span class="line">        <span class="keyword">this</span>.configInstance = configInstance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSessionedClientReconnectIntervalSeconds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInstance.getIntProperty(namespace + SESSION_RECONNECT_INTERVAL_KEY, Values.SESSION_RECONNECT_INTERVAL).get();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.构建函数创建 DynamicPropertyFactory</p>
<ol start="2">
<li>构建函数 初始化namespace 配置key的前缀</li>
<li>获取配置信息通过DynamicPropertyFactory 动态在配置文件中获取</li>
</ol>
</blockquote>
<h4 id="EurekaHttpClients-工具类"><a href="#EurekaHttpClients-工具类" class="headerlink" title="EurekaHttpClients 工具类"></a>EurekaHttpClients 工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpClients</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(EurekaHttpClients.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">EurekaHttpClients</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">queryClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             TransportClientFactory transportClientFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             EurekaClientConfig clientConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             EurekaTransportConfig transportConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             InstanceInfo myInstanceInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                             ApplicationsResolver.ApplicationsSource applicationsSource)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ClosableResolver queryResolver = transportConfig.useBootstrapResolverForQuery()</span><br><span class="line">                ? wrapClosable(bootstrapResolver)</span><br><span class="line">                : queryClientResolver(bootstrapResolver, transportClientFactory,</span><br><span class="line">                clientConfig, transportConfig, myInstanceInfo, applicationsSource);</span><br><span class="line">        <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.QUERY, transportConfig, queryResolver, transportClientFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EurekaHttpClientFactory <span class="title">registrationClientFactory</span><span class="params">(ClusterResolver bootstrapResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                    TransportClientFactory transportClientFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                    EurekaTransportConfig transportConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> canonicalClientFactory(EurekaClientNames.REGISTRATION, transportConfig, bootstrapResolver, transportClientFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> EurekaHttpClientFactory <span class="title">canonicalClientFactory</span><span class="params">(<span class="keyword">final</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          <span class="keyword">final</span> EurekaTransportConfig transportConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          <span class="keyword">final</span> ClusterResolver&lt;EurekaEndpoint&gt; clusterResolver,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                          <span class="keyword">final</span> TransportClientFactory transportClientFactory)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EurekaHttpClientFactory() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> SessionedEurekaHttpClient(</span><br><span class="line">                        name,</span><br><span class="line">                        RetryableEurekaHttpClient.createFactory(</span><br><span class="line">                                name,</span><br><span class="line">                                transportConfig,</span><br><span class="line">                                clusterResolver,</span><br><span class="line">                                RedirectingEurekaHttpClient.createFactory(transportClientFactory),</span><br><span class="line">                                ServerStatusEvaluators.legacyEvaluator()),</span><br><span class="line">                        transportConfig.getSessionedClientReconnectIntervalSeconds() * <span class="number">1000</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                wrapClosable(clusterResolver).shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>EurekaHttpClients，是创建EurekaHttpClientFactory的工具类</p>
</blockquote>
<h4 id="EurekaHttpClient-Low-Level部分"><a href="#EurekaHttpClient-Low-Level部分" class="headerlink" title="EurekaHttpClient Low Level部分"></a>EurekaHttpClient Low Level部分</h4><ul>
<li>JerseyEurekaHttpClientFactory</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JerseyEurekaHttpClientFactory</span> <span class="keyword">implements</span> <span class="title">TransportClientFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HTTP_X_DISCOVERY_ALLOW_REDIRECT = <span class="string">"X-Discovery-AllowRedirect"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EurekaJerseyClient jerseyClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClient4 apacheClient;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApacheHttpClientConnectionCleaner cleaner;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; additionalHeaders;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JerseyEurekaHttpClientFactory</span><span class="params">(EurekaJerseyClient jerseyClient,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          ApacheHttpClient4 apacheClient,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">long</span> connectionIdleTimeout,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          Map&lt;String, String&gt; additionalHeaders)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jerseyClient = jerseyClient;</span><br><span class="line">        <span class="keyword">this</span>.apacheClient = jerseyClient != <span class="keyword">null</span> ? jerseyClient.getClient() : apacheClient;</span><br><span class="line">        <span class="keyword">this</span>.additionalHeaders = additionalHeaders;</span><br><span class="line">        <span class="keyword">this</span>.cleaner = <span class="keyword">new</span> ApacheHttpClientConnectionCleaner(<span class="keyword">this</span>.apacheClient, connectionIdleTimeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务创建JerseyApplicationClient</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endpoint</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpClient <span class="title">newClient</span><span class="params">(EurekaEndpoint endpoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JerseyApplicationClient(apacheClient, endpoint.getServiceUrl(), additionalHeaders);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>JerseyEurekaHttpClientFactory 为TransportClientFactory的Jersey1实现主要负责创建JerseyEurekaHttpClient </p>
</blockquote>
<ul>
<li>AbstractJerseyEurekaHttpClient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractJerseyEurekaHttpClient</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(AbstractJerseyEurekaHttpClient.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jersey1 http 客户端，负责底层发送http请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Client jerseyClient;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * server url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String serviceUrl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractJerseyEurekaHttpClient</span><span class="params">(Client jerseyClient, String serviceUrl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jerseyClient = jerseyClient;</span><br><span class="line">        <span class="keyword">this</span>.serviceUrl = serviceUrl;</span><br><span class="line">        logger.debug(<span class="string">"Created client for url: &#123;&#125;"</span>, serviceUrl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务注册</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> info</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</span><br><span class="line">        String urlPath = <span class="string">"apps/"</span> + info.getAppName();</span><br><span class="line">        ClientResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//通过HTTP客户端发送http请求</span></span><br><span class="line">            Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</span><br><span class="line">            addExtraHeaders(resourceBuilder);</span><br><span class="line">            <span class="comment">//构建响应结果</span></span><br><span class="line">            response = resourceBuilder</span><br><span class="line">                    .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">                    .type(MediaType.APPLICATION_JSON_TYPE)</span><br><span class="line">                    .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">                    .post(ClientResponse.class, info);</span><br><span class="line">            <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</span><br><span class="line">                        response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>1.通过构建函数 可以看到传入一个jersey1 http 客户端</p>
<ol start="2">
<li>register方法 实际是通过jersey1HttpClient发送http底层请求</li>
</ol>
</blockquote>
<blockquote>
<p>在这里可以看到AbstractJerseyEurekaHttpClient实际上是不做底层通讯的工作的，全部都是交由com.sun.jersey.api.client.Client处理的，这个是在创建工厂创建时设置到AbstractJerseyEurekaHttpClient中的</p>
</blockquote>
<blockquote>
<p><strong>备注:</strong> AbstractJersey2EurekaHttpClient与AbstractJerseyEurekaHttpClient的实现原理基本一样只是底层通讯的client不一致，后边不在描述</p>
</blockquote>
<h4 id="EurekaHttpClient-Top-Level部分"><a href="#EurekaHttpClient-Top-Level部分" class="headerlink" title="EurekaHttpClient Top Level部分"></a>EurekaHttpClient Top Level部分</h4><ul>
<li>EurekaHttpClientDecorator</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象Eureka远程通讯客户端装饰器，使用设计模式-装饰器模式 为客户端添加新的功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Tomasz Bak</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaHttpClientDecorator</span> <span class="keyword">implements</span> <span class="title">EurekaHttpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> RequestType &#123;</span><br><span class="line">        <span class="comment">//注册</span></span><br><span class="line">        Register,</span><br><span class="line">        <span class="comment">//下线</span></span><br><span class="line">        Cancel,</span><br><span class="line">        <span class="comment">//心跳</span></span><br><span class="line">        SendHeartBeat,</span><br><span class="line">        <span class="comment">//状态更新</span></span><br><span class="line">        StatusUpdate,</span><br><span class="line">        DeleteStatusOverride,</span><br><span class="line">        GetApplications,</span><br><span class="line">        GetDelta,</span><br><span class="line">        GetVip,</span><br><span class="line">        GetSecureVip,</span><br><span class="line">        GetApplication,</span><br><span class="line">        GetInstance,</span><br><span class="line">        GetApplicationInstance</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求执行接口，负责执行请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestExecutor</span>&lt;<span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 执行请求并返回响应信息</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> delegate 目标的客户端</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 请求的类型</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function">RequestType <span class="title">getRequestType</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 抽象的执行方法，由子装饰器实现，附加其它功能</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestExecutor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;R&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(<span class="keyword">final</span> InstanceInfo info)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个注册请求的执行器，并执行</span></span><br><span class="line">        <span class="keyword">return</span> execute(<span class="keyword">new</span> RequestExecutor&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> delegate.register(info);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RequestType <span class="title">getRequestType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RequestType.Register;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">cancel</span><span class="params">(<span class="keyword">final</span> String appName, <span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//创建一个下线请求的执行，并执行</span></span><br><span class="line">        <span class="keyword">return</span> execute(<span class="keyword">new</span> RequestExecutor&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">execute</span><span class="params">(EurekaHttpClient delegate)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> delegate.cancel(appName, id);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> RequestType <span class="title">getRequestType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RequestType.Cancel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>基础的包装器 主要完成如下功能</p>
<ul>
<li>实现EurekaHttpClient接口每个基础方法，都有如下流程</li>
</ul>
<ol>
<li>创建一个请求执行接口</li>
<li>通过调用抽象的execute方法将RequestExecutor传入</li>
<li>子类在RequestExecutor执行前或后完成新功能的附加</li>
</ol>
</blockquote>
<ul>
<li>EurekaHttpClientDecorator实现</li>
</ul>
<table>
<thead>
<tr>
<th>实现类</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>MetricsCollectingEurekaHttpClient</td>
<td>实现请求响应状态指标采集的Eureka远程通讯客户端装饰器，为EurekaHttpClient添加响应状态指标采集向功能</td>
</tr>
<tr>
<td>RedirectingEurekaHttpClient</td>
<td>实现请求重定向的Eureka远程通讯客户端装饰器，为EurekaHttpClient添加请求重定向功能</td>
</tr>
<tr>
<td>RetryableEurekaHttpClient</td>
<td>实现请求失败重试的Eureka远程通讯客户端装饰器，为EurekaHttpClient添加失败重试功能</td>
</tr>
<tr>
<td>SessionedEurekaHttpClient</td>
<td>TODO</td>
</tr>
</tbody>
</table>
<hr>
<blockquote>
<p>从以上来看eureka 通讯模块结构和功能还是非常明了清晰，同时后期如果需要扩展，也是非常方便与快捷的</p>
</blockquote>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">4</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/微服务/" style="font-size: 10px;">微服务</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/08/25/Eureka之远程通讯模块/">Eureka之远程通讯模块</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/23/Eureka之REST-API-1/">Eureka之REST API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/23/Eureka之服务注册数据模型/">Eureka之服务注册数据模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/23/Eureka之server端集群节点发现，数据同步-1/">Eureka之server端集群节点发现，数据同步</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/23/hello-world/">Hello World</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/08/23/Eureka之REST-API-1/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="#" target="_blank">Mr.G</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>陕ICP备16007301</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>