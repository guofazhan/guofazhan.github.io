<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Eureka之服务发现LookupService · Mr.G-博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Eureka之服务发现LookupService - Mr.G"><meta name="keywords"><meta name="author" content="Mr.G"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://guofazhan.github.io/atom.xml" title="Mr.G-博客"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Eureka之服务发现LookupService</h1><div class="post-info">2018-08-28<!-- p.visit--><!--    if (is_home())--><!--        i(data-hk-page='http://bubuzou.com'+url_for(item.path)) ---><!--    else--><!--        i(data-hk-page="current") ---><!--   span 次访问--></div><div class="post-content"><blockquote>
<p>Eureka 注册中心，核心为提供服务注册，以及服务发现功能，下面我们重点讨论下Eureka核心功能之一的服务发现。<br>我们知道Eureka采用的C-S架构，客户端要通过请求服务端获取注册列表，提供给服务使用，服务端要保存客户端发来的注册信息保存下（Eureka采用的是内存存储），并提供给资源服务Resources使用，有关资源服务可见Eureka之REST API<br><a id="more"></a></p>
</blockquote>
<h4 id="LookupService体系图"><a href="#LookupService体系图" class="headerlink" title="LookupService体系图"></a>LookupService体系图</h4><p><img src="https://github.com/guofazhan/image/blob/master/LookupService.png?raw=true" alt="image"></p>
<blockquote>
<ol>
<li>InstanceRegistry为Server端对资源服务提供服务发现功能的接口，用来读取服务端本地缓存注册表信息</li>
<li>EurekaClient 为Client端实现的服务发现接口，用来获取客户端本地缓存中的注册表信息</li>
<li>RemoteRegionRegistry 为Server用来读取其它区域的服务注册表的接口，并将其它区域的服务注册表缓存到本地，供本地InstanceRegistry使用。</li>
</ol>
</blockquote>
<h4 id="Eureka区域，分区"><a href="#Eureka区域，分区" class="headerlink" title="Eureka区域，分区"></a>Eureka区域，分区</h4><blockquote>
<p> eureka提供了region和zone两个概念来进行分区，这两个概念均来自于亚马逊的AWS：</p>
<ol>
<li>region：可以简单理解为地理上的分区，比如亚洲地区，或者华北地区，再或者北京等等，没有具体大小的限制。根据项目具体的情况，可以自行合理划分region。RemoteRegionRegistry就是其它分区的服务注册信息。</li>
<li>zone：可以简单理解为region内的具体机房，比如说region划分为北京，然后北京有两个机房，就可以在此region之下划分出zone1,zone2两个zone。</li>
</ol>
</blockquote>
<blockquote>
<p>RemoteRegionRegistry 根据配置实例化：         </p>
<ol>
<li>配置KEY： eureka.remoteRegionUrlsWithName   </li>
<li>格式： eureka.remoteRegionUrlsWithName=region1;<a href="http://region1host/eureka/v2,region2;http://region2host/eureka/v2" target="_blank" rel="noopener">http://region1host/eureka/v2,region2;http://region2host/eureka/v2</a></li>
<li>解析: regionName-&gt;remoteRegionURL 根据解析出来的MAP 创建相应的 RemoteRegionRegistry</li>
</ol>
</blockquote>
<blockquote>
<p><strong><em>备注：</em></strong> 一般中小行项目基本所有服务都部署在同一机房，不存在区域划分这些，即初始化时:RemoteRegionRegistry List为空,具体可参见AbstractInstanceRegistry的initRemoteRegionRegistry方法</p>
</blockquote>
<h4 id="LookupService类图以及实现"><a href="#LookupService类图以及实现" class="headerlink" title="LookupService类图以及实现"></a>LookupService类图以及实现</h4><p><img src="https://github.com/guofazhan/image/blob/master/LookupServiceUml.png?raw=true" alt="image"></p>
<h5 id="服务发现LookupService接口"><a href="#服务发现LookupService接口" class="headerlink" title="服务发现LookupService接口"></a>服务发现LookupService接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务发现接口</span></span><br><span class="line"><span class="comment"> * Lookup service for finding active instances.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Karthik Ranganathan, Greg Kim.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; for backward compatibility</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LookupService</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据集群ID获取集群列表</span></span><br><span class="line"><span class="comment">     * Returns the corresponding &#123;<span class="doctag">@link</span> Application&#125; object which is basically a</span></span><br><span class="line"><span class="comment">     * container of all registered &lt;code&gt;appName&lt;/code&gt; &#123;<span class="doctag">@link</span> InstanceInfo&#125;s.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> appName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Application&#125; or null if we couldn't locate any app of</span></span><br><span class="line"><span class="comment">     *         the requested appName</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Application <span class="title">getApplication</span><span class="params">(String appName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取服务注册列表</span></span><br><span class="line"><span class="comment">     * Returns the &#123;<span class="doctag">@link</span> Applications&#125; object which is basically a container of</span></span><br><span class="line"><span class="comment">     * all currently registered &#123;<span class="doctag">@link</span> Application&#125;s.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &#123;<span class="doctag">@link</span> Applications&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Applications <span class="title">getApplications</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据实例ID获取实例信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 轮询获取集群中的下一个可用的注册服务，起到负载均衡作用，保证每个可用注册服务均衡的被使用，此方法仅提供个Eureka 客户端使用实现，服务端默认为空实现</span></span><br><span class="line"><span class="comment">     * Gets the next possible server to process the requests from the registry</span></span><br><span class="line"><span class="comment">     * information received from eureka.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">InstanceInfo <span class="title">getNextServerFromEureka</span><span class="params">(String virtualHostname, <span class="keyword">boolean</span> secure)</span></span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从接口可以看到提供了四个功能方法如下：</p>
<ol>
<li>getApplication:根据集群ID获取集群列表</li>
<li>getApplications:获取服务注册列表</li>
<li>getInstancesById:根据实例ID获取实例信息</li>
<li>getNextServerFromEureka:轮询获取集群中的下一个可用的注册服务，起到负载均衡作用，保证每个可用注册服务均衡的被使用，此方法仅提供个Eureka 客户端使用实现，服务端默认为空实现</li>
</ol>
</blockquote>
<h5 id="服务端实现AbstractInstanceRegistry"><a href="#服务端实现AbstractInstanceRegistry" class="headerlink" title="服务端实现AbstractInstanceRegistry"></a>服务端实现AbstractInstanceRegistry</h5><ol>
<li>缓存服务注册属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 服务注册表</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry</span><br><span class="line">         = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>其它区域服务发现集合属性</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 远程区域服务发现注册服务集合</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> Map&lt;String, RemoteRegionRegistry&gt; regionNameVSRemoteRegistry = <span class="keyword">new</span> HashMap&lt;String, RemoteRegionRegistry&gt;();</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>getApplications功能方法实现</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取服务注册列表信息</span></span><br><span class="line"><span class="comment"> * Get all applications in this instance registry, falling back to other regions if allowed in the Eureka config.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the list of all known applications</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.netflix.discovery.shared.LookupService#getApplications()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//配置参数，是否禁用远程区域的服务注册列表</span></span><br><span class="line">    <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</span><br><span class="line">    <span class="keyword">if</span> (disableTransparentFallback) &#123;</span><br><span class="line">        <span class="comment">//获取本地服务注册列表</span></span><br><span class="line">        <span class="keyword">return</span> getApplicationsFromLocalRegionOnly();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//获取服务注册列表在所有区域中，包含本地</span></span><br><span class="line">        <span class="keyword">return</span> getApplicationsFromAllRemoteRegions();  <span class="comment">// Behavior of falling back to remote region can be disabled.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获服务注册列表,在所有区域</span></span><br><span class="line"><span class="comment"> * Returns applications including instances from all remote regions. &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * Same as calling &#123;<span class="doctag">@link</span> #getApplicationsFromMultipleRegions(String[])&#125; with a &lt;code&gt;null&lt;/code&gt; argument.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromAllRemoteRegions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//根据区域信息获取服务注册列表，此处区域列表传入所有远程区域列表</span></span><br><span class="line">    <span class="keyword">return</span> getApplicationsFromMultipleRegions(allKnownRemoteRegions);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取本地服务注册列表</span></span><br><span class="line"><span class="comment"> * Returns applications including instances from local region only. &lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * Same as calling &#123;<span class="doctag">@link</span> #getApplicationsFromMultipleRegions(String[])&#125; with an empty array.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromLocalRegionOnly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//根据区域信息获取服务注册列表，此处区域列表传入空值</span></span><br><span class="line">    <span class="keyword">return</span> getApplicationsFromMultipleRegions(EMPTY_STR_ARRAY);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据区域信息查询服务注册列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromMultipleRegions</span><span class="params">(String[] remoteRegions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否根据远程区域查询服务注册列表标识</span></span><br><span class="line">    <span class="keyword">boolean</span> includeRemoteRegion = <span class="keyword">null</span> != remoteRegions &amp;&amp; remoteRegions.length != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    logger.debug(<span class="string">"Fetching applications registry with remote regions: &#123;&#125;, Regions argument &#123;&#125;"</span>,</span><br><span class="line">            includeRemoteRegion, Arrays.toString(remoteRegions));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录统计监控数据</span></span><br><span class="line">    <span class="keyword">if</span> (includeRemoteRegion) &#123;</span><br><span class="line">        GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS.increment();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        GET_ALL_CACHE_MISS.increment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//构建服务注册列表实例信息</span></span><br><span class="line">    Applications apps = <span class="keyword">new</span> Applications();</span><br><span class="line">    apps.setVersion(<span class="number">1L</span>);</span><br><span class="line">    <span class="comment">//加入本地注册信息到服务注册列表实例中</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; entry : registry.entrySet()) &#123;</span><br><span class="line">        Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (entry.getValue() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; stringLeaseEntry : entry.getValue().entrySet()) &#123;</span><br><span class="line">                Lease&lt;InstanceInfo&gt; lease = stringLeaseEntry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    app = <span class="keyword">new</span> Application(lease.getHolder().getAppName());</span><br><span class="line">                &#125;</span><br><span class="line">                app.addInstance(decorateInstanceInfo(lease));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">            apps.addApplication(app);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//是否加入远程区域的注册信息</span></span><br><span class="line">    <span class="keyword">if</span> (includeRemoteRegion) &#123;</span><br><span class="line">        <span class="comment">//遍历远程区域，添加远程区域的注册信息到服务注册列表实例</span></span><br><span class="line">        <span class="keyword">for</span> (String remoteRegion : remoteRegions) &#123;</span><br><span class="line">            RemoteRegionRegistry remoteRegistry = regionNameVSRemoteRegistry.get(remoteRegion);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegistry) &#123;</span><br><span class="line">                Applications remoteApps = remoteRegistry.getApplications();</span><br><span class="line">                <span class="keyword">for</span> (Application application : remoteApps.getRegisteredApplications()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (shouldFetchFromRemoteRegistry(application.getName(), remoteRegion)) &#123;</span><br><span class="line">                        logger.info(<span class="string">"Application &#123;&#125;  fetched from the remote region &#123;&#125;"</span>,</span><br><span class="line">                                application.getName(), remoteRegion);</span><br><span class="line"></span><br><span class="line">                        Application appInstanceTillNow = apps.getRegisteredApplications(application.getName());</span><br><span class="line">                        <span class="keyword">if</span> (appInstanceTillNow == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            appInstanceTillNow = <span class="keyword">new</span> Application(application.getName());</span><br><span class="line">                            apps.addApplication(appInstanceTillNow);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (InstanceInfo instanceInfo : application.getInstances()) &#123;</span><br><span class="line">                            appInstanceTillNow.addInstance(instanceInfo);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.debug(<span class="string">"Application &#123;&#125; not fetched from the remote region &#123;&#125; as there exists a "</span></span><br><span class="line">                                        + <span class="string">"whitelist and this app is not in the whitelist."</span>,</span><br><span class="line">                                application.getName(), remoteRegion);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">"No remote registry available for the remote region &#123;&#125;"</span>, remoteRegion);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置实例的hashCode</span></span><br><span class="line">    apps.setAppsHashCode(apps.getReconcileHashCode());</span><br><span class="line">    <span class="keyword">return</span> apps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>getApplications功能主要由以下方法完成：</p>
<ol>
<li>getApplications : 此方法根据配置参数信息，判断是只从本地缓存中获取注册列表(getApplicationsFromLocalRegionOnly)还是从所以区域获取注册列表(getApplicationsFromAllRemoteRegions)，参数信息：disableTransparentFallback</li>
<li>getApplicationsFromLocalRegionOnly :获取本地缓存中的注册表信息，调用getApplicationsFromMultipleRegions传入空区域集合</li>
<li>getApplicationsFromAllRemoteRegions : 从所有区域查找注册表信息，传入全部区域集合。</li>
<li>getApplicationsFromMultipleRegions ：根据传入区域信息查询注册表信息</li>
</ol>
</blockquote>
<blockquote>
<p> getApplicationsFromMultipleRegions完成如下功能:</p>
<ol>
<li>构建空注册表实例：Applications</li>
<li>添加本地缓存的注册信息到Applications</li>
<li>判断是否查找其它区域</li>
<li>遍历其它区域RemoteRegionRegistry获取Applications</li>
<li>添加其它区域中注册的信息到Applications（剔除重复的）</li>
<li>设置apps的hashCode 用于增量更新</li>
</ol>
</blockquote>
<ol start="4">
<li>getApplications功能方法实现</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据服务集群ID，查询服务集群列表</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> appName the application name of the application</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.netflix.discovery.shared.LookupService#getApplication(java.lang.String)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">getApplication</span><span class="params">(String appName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取配置信息</span></span><br><span class="line">    <span class="comment">//配置参数，是否禁用远程区域的服务注册列表</span></span><br><span class="line">    <span class="keyword">boolean</span> disableTransparentFallback = serverConfig.disableTransparentFallbackToOtherRegion();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getApplication(appName, !disableTransparentFallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据服务集群ID，查询服务集群列表</span></span><br><span class="line"><span class="comment"> * Get application information.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the application</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">getApplication</span><span class="params">(String appName, <span class="keyword">boolean</span> includeRemoteRegion)</span> </span>&#123;</span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取本地注册列表中的服务集群信息</span></span><br><span class="line">    Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; leaseMap = registry.get(appName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (leaseMap != <span class="keyword">null</span> &amp;&amp; leaseMap.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//构建集群实例Application</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; entry : leaseMap.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">                app = <span class="keyword">new</span> Application(appName);</span><br><span class="line">            &#125;</span><br><span class="line">            app.addInstance(decorateInstanceInfo(entry.getValue()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (includeRemoteRegion) &#123;</span><br><span class="line">        <span class="comment">//包含远程区域时，通过远程区域注册服务查询集群信息</span></span><br><span class="line">        <span class="keyword">for</span> (RemoteRegionRegistry remoteRegistry : <span class="keyword">this</span>.regionNameVSRemoteRegistry.values()) &#123;</span><br><span class="line">            Application application = remoteRegistry.getApplication(appName);</span><br><span class="line">            <span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> application;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回集群实例</span></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>getApplication功能主要由以下方法完成：<br>getApplication ： 根据 集群名称以及参数是否禁用其它区域来获取集群列表Application</p>
<ol>
<li>通过本地缓存注册信息获取组装集群实例Application</li>
<li>当本地缓存中未查到集群信息且可用远程区域发现服务查询时，遍历远程区域发现服务查询集群信息组装<br>集群实例Application</li>
<li>返回集群实例Application</li>
</ol>
</blockquote>
<ol start="5">
<li>getInstancesById功能方法实现<blockquote>
<p>与4功能类似</p>
</blockquote>
</li>
<li>getNextServerFromEureka功能方法实现<blockquote>
<p>空实现</p>
</blockquote>
</li>
</ol>
<h5 id="客户端实现DiscoveryClient"><a href="#客户端实现DiscoveryClient" class="headerlink" title="客户端实现DiscoveryClient"></a>客户端实现DiscoveryClient</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (non-Javadoc)</span></span><br><span class="line"><span class="comment"> * @see com.netflix.discovery.shared.LookupService#getApplication(java.lang.String)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">getApplication</span><span class="params">(String appName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getApplications().getRegisteredApplications(appName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (non-Javadoc)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @see com.netflix.discovery.shared.LookupService#getApplications()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplications</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> localRegionApps.get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment"> * (non-Javadoc)</span></span><br><span class="line"><span class="comment"> * @see com.netflix.discovery.shared.LookupService#getInstancesById(java.lang.String)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;InstanceInfo&gt; <span class="title">getInstancesById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    List&lt;InstanceInfo&gt; instancesList = <span class="keyword">new</span> ArrayList&lt;InstanceInfo&gt;();</span><br><span class="line">    <span class="keyword">for</span> (Application app : <span class="keyword">this</span>.getApplications()</span><br><span class="line">            .getRegisteredApplications()) &#123;</span><br><span class="line">        InstanceInfo instanceInfo = app.getByInstanceId(id);</span><br><span class="line">        <span class="keyword">if</span> (instanceInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            instancesList.add(instanceInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instancesList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在客户端的实现方法中可以清晰的看到是通过localRegionApps.get()获取服务注册列表实例，此实例是在本地缓存存储且为原子性的。下面我们主要查看localRegionApps是怎么加载以及更新</p>
</blockquote>
<ul>
<li>构造函数首次加载localRegionApps</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//通过fetchRegistry方法首次从远程Server端获取注册列表缓存到客户端本地，默认选择增量拉取</span></span><br><span class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry() &amp;&amp; !fetchRegistry(<span class="keyword">false</span>)) &#123;</span><br><span class="line">    fetchRegistryFromBackup();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在构造函数中调用fetchRegistry 首次初始化从服务端拉取服务注册实例并缓存到客户端内存中</p>
<ul>
<li>初始化定时任务，定时拉取服务端注册信息刷新本地缓存</li>
</ul>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Initializes all scheduled tasks.</span><br><span class="line"> */</span><br><span class="line">private void initScheduledTasks() &#123;</span><br><span class="line">    //判断客户端远程拉取注册表禁用配置，true，标识客户端运行定时拉取远程注册表配置</span><br><span class="line">    if (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">        // registry cache refresh timer</span><br><span class="line">        int registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">        int expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">        //定时任务定时执行客户端远程拉取注册表来更新客户端本地缓存</span><br><span class="line">        scheduler.schedule(</span><br><span class="line">                new TimedSupervisorTask(</span><br><span class="line">                        &quot;cacheRefresh&quot;,</span><br><span class="line">                        scheduler,</span><br><span class="line">                        cacheRefreshExecutor,</span><br><span class="line">                        registryFetchIntervalSeconds,</span><br><span class="line">                        TimeUnit.SECONDS,</span><br><span class="line">                        expBackOffBound,</span><br><span class="line">                        new CacheRefreshThread()</span><br><span class="line">                ),</span><br><span class="line">                registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line"> * 远程拉取Server端注册表信息更新客户端本地缓存，定时任务，客户端定时执行此任务</span><br><span class="line"> * The task that fetches the registry information at specified intervals.</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">class CacheRefreshThread implements Runnable &#123;</span><br><span class="line">    public void run() &#123;</span><br><span class="line">        refreshRegistry();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>构造函数初始化定时任务，调用initScheduledTasks</li>
<li>定时任务，初始化刷新服务注册表实例定时任务</li>
<li>CacheRefreshThread线程定时执行，调用refreshRegistry()方法从server端拉取注册信息并刷新本地缓存</li>
</ol>
</blockquote>
<ul>
<li>fetchRegistry功能</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端拉取Eureka Server服务注册列表，本地缓存 (forceFullRegistryFetch 是否全量拉取标识)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</span><br><span class="line">        Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// If the delta is disabled or if it is the first time, get all</span></span><br><span class="line">            <span class="comment">// applications</span></span><br><span class="line">            <span class="comment">//本地缓存中获取注册列表信息</span></span><br><span class="line">            Applications applications = getApplications();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//判断全量拉取还是增量拉取</span></span><br><span class="line">            <span class="keyword">if</span> (clientConfig.shouldDisableDelta()</span><br><span class="line">                    || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">                    || forceFullRegistryFetch</span><br><span class="line">                    || (applications == <span class="keyword">null</span>)</span><br><span class="line">                    || (applications.getRegisteredApplications().size() == <span class="number">0</span>)</span><br><span class="line">                    || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//全量拉取注册表信息</span></span><br><span class="line">                getAndStoreFullRegistry();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//增量拉取注册表信息</span></span><br><span class="line">                getAndUpdateDelta(applications);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//设置hashCode，注册列表判断变化是根据hashCode</span></span><br><span class="line">            applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">            <span class="comment">//日志打印统计</span></span><br><span class="line">            logTotalInstances();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            logger.error(PREFIX + appPathIdentifier + <span class="string">" - was unable to refresh its cache! status = "</span> + e.getMessage(), e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">                tracer.stop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通知缓存刷新事件</span></span><br><span class="line">        <span class="comment">// Notify about cache refresh before updating the instance remote status</span></span><br><span class="line">        onCacheRefreshed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新实例的远程状态</span></span><br><span class="line">        <span class="comment">// Update remote status based on refreshed data held in the cache</span></span><br><span class="line">        updateInstanceRemoteStatus();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// registry was fetched successfully, so return true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 全量拉取Eureka Server端的注册列表信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndStoreFullRegistry</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">"Getting all instance registry info from the eureka server"</span>);</span><br><span class="line"></span><br><span class="line">        Applications apps = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//通过远程通讯组件请求Server端获取全量注册列表</span></span><br><span class="line">        EurekaHttpResponse&lt;Applications&gt; httpResponse = clientConfig.getRegistryRefreshSingleVipAddress() == <span class="keyword">null</span></span><br><span class="line">                ? eurekaTransport.queryClient.getApplications(remoteRegionsRef.get())</span><br><span class="line">                : eurekaTransport.queryClient.getVip(clientConfig.getRegistryRefreshSingleVipAddress(), remoteRegionsRef.get());</span><br><span class="line">        <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</span><br><span class="line">            apps = httpResponse.getEntity();</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(<span class="string">"The response status is &#123;&#125;"</span>, httpResponse.getStatusCode());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (apps == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">"The application is null for some reason. Not storing this information"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">//获取的注册列表缓存到本地</span></span><br><span class="line">            localRegionApps.set(<span class="keyword">this</span>.filterAndShuffle(apps));</span><br><span class="line">            logger.debug(<span class="string">"Got full registry with apps hashcode &#123;&#125;"</span>, apps.getAppsHashCode());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Not updating applications as another thread is updating it already"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增量拉取Eureka Server端的注册列表信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getAndUpdateDelta</span><span class="params">(Applications applications)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currentUpdateGeneration = fetchRegistryGeneration.get();</span><br><span class="line"></span><br><span class="line">        Applications delta = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//通过远程通讯组件请求Server端获取增量注册列表</span></span><br><span class="line">        EurekaHttpResponse&lt;Applications&gt; httpResponse = eurekaTransport.queryClient.getDelta(remoteRegionsRef.get());</span><br><span class="line">        <span class="keyword">if</span> (httpResponse.getStatusCode() == Status.OK.getStatusCode()) &#123;</span><br><span class="line">            delta = httpResponse.getEntity();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (delta == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">"The server does not allow the delta revision to be applied because it is not safe. "</span></span><br><span class="line">                    + <span class="string">"Hence got the full registry."</span>);</span><br><span class="line">            <span class="comment">//增量获取为空时，全量拉取</span></span><br><span class="line">            getAndStoreFullRegistry();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (fetchRegistryGeneration.compareAndSet(currentUpdateGeneration, currentUpdateGeneration + <span class="number">1</span>)) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Got delta update with apps hashcode &#123;&#125;"</span>, delta.getAppsHashCode());</span><br><span class="line">            String reconcileHashCode = <span class="string">""</span>;</span><br><span class="line">            <span class="comment">//拉取注册表更新锁</span></span><br><span class="line">            <span class="keyword">if</span> (fetchRegistryUpdateLock.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//更新增量信息到本地缓存中的注册表中</span></span><br><span class="line">                    updateDelta(delta);</span><br><span class="line">                    <span class="comment">//获取更新后的HashCode</span></span><br><span class="line">                    reconcileHashCode = getReconcileHashCode(applications);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    fetchRegistryUpdateLock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logger.warn(<span class="string">"Cannot acquire update lock, aborting getAndUpdateDelta"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//判断本地的hashCode是否与远程hashCode一致，不一致时，需要同步一致</span></span><br><span class="line">            <span class="comment">// There is a diff in number of instances for some reason</span></span><br><span class="line">            <span class="keyword">if</span> (!reconcileHashCode.equals(delta.getAppsHashCode()) || clientConfig.shouldLogDeltaDiff()) &#123;</span><br><span class="line">                reconcileAndLogDifference(delta, reconcileHashCode);  <span class="comment">// this makes a remoteCall</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"Not updating application delta as another thread is updating it already"</span>);</span><br><span class="line">            logger.debug(<span class="string">"Ignoring delta update with apps hashcode &#123;&#125;, as another thread is updating it already"</span>, delta.getAppsHashCode());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>fetchRegistry : 根据传入参数以及配置信息判断是否全量拉取还是增量拉取，全量拉取调用getAndStoreFullRegistry方法 ；增量拉取调用getAndUpdateDelta方法</li>
<li>getAndStoreFullRegistry：全量从Server拉取服务注册信息，更新本地缓存。此方法通过Eureka提供的远程通讯模块调用Server端暴露的Resources信息获取服务注册列表实例apps</li>
<li>getAndUpdateDelta ：增量从Server端拉取服务的增量注册信息，更新本地缓存实例。</li>
</ol>
</blockquote>
<h5 id="远程区域服务发现实现RemoteRegionRegistry"><a href="#远程区域服务发现实现RemoteRegionRegistry" class="headerlink" title="远程区域服务发现实现RemoteRegionRegistry"></a>远程区域服务发现实现RemoteRegionRegistry</h5><blockquote>
<p>与客户端实现方式基本一致，不在描述</p>
</blockquote>
<h4 id="客户端，服务端，远程区域服务端交互"><a href="#客户端，服务端，远程区域服务端交互" class="headerlink" title="客户端，服务端，远程区域服务端交互"></a>客户端，服务端，远程区域服务端交互</h4><p><img src="https://github.com/guofazhan/image/blob/master/LookupService1.png?raw=true" alt="image"></p>
<hr>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud-Gateway/">Spring-Cloud-Gateway</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">7</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Eureka/" style="font-size: 16.67px;">Eureka</a> <a href="/tags/Hystrix/" style="font-size: 10px;">Hystrix</a> <a href="/tags/微服务/" style="font-size: 20px;">微服务</a> <a href="/tags/网关/" style="font-size: 13.33px;">网关</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/zuul之过滤器Filter管理/">zuul之过滤器Filter管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/zuul之动态过滤器Filter类文件管理加载/">zuul之动态过滤器Filter类文件管理加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/zuul之请求处理流程/">zuul之请求处理流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/11/Hystrix之信号量隔离熔断/">Hystrix之信号量隔离熔断</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Spring-Cloud-Gateway之配置路由过滤器/">Spring-Cloud-Gateway之配置路由过滤器</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/09/03/Spring-Cloud-Gateway之route数据模型/" class="prev">上一篇</a><a href="/2018/08/25/Eureka之远程通讯模块/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="#" target="_blank">Mr.G</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>陕ICP备16007301</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>