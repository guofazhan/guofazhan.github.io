<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Spring-Cloud-Gateway之请求处理流程 · Mr.G-博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Spring-Cloud-Gateway之请求处理流程 - Mr.G"><meta name="keywords"><meta name="author" content="Mr.G"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://guofazhan.github.io/atom.xml" title="Mr.G-博客"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Spring-Cloud-Gateway之请求处理流程</h1><div class="post-info">2018-09-03<!-- p.visit--><!--    if (is_home())--><!--        i(data-hk-page='http://bubuzou.com'+url_for(item.path)) ---><!--    else--><!--        i(data-hk-page="current") ---><!--   span 次访问--></div><div class="post-content"><p>Spring-Cloud-Gateway 初始化，路由模型，以及路由加载等源码在上几篇学习文档中已经描述，接下来来看Spring-Cloud-Gateway是怎么通过这些来对我们的请求进行路由处理的</p>
<hr>
<a id="more"></a>
<blockquote>
<p>Spring-Cloud-Gateway整体流程图</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/guofazhan/image/master/gateway.png" alt="image"></p>
<blockquote>
<ul>
<li>DispatcherHandler：所有请求的调度器，负载请求分发</li>
<li>RoutePredicateHandlerMapping:路由谓语匹配器，用于路由的查找，以及找到路由后返回对应的WebHandler，DispatcherHandler会依次遍历HandlerMapping集合进行处理</li>
<li>FilteringWebHandler : 使用Filter链表处理请求的WebHandler，RoutePredicateHandlerMapping找到路由后返回对应的FilteringWebHandler对请求进行处理，FilteringWebHandler负责组装Filter链表并调用链表处理请求。</li>
</ul>
</blockquote>
<hr>
<ol>
<li>DispatcherHandler</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.reactive.DispatcherHandler</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">			ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">			logger.debug(<span class="string">"Processing "</span> + request.getMethodValue() + <span class="string">" request for ["</span> + request.getURI() + <span class="string">"]"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//校验handlerMapping集合是否为空</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.handlerMappings == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> Mono.error(HANDLER_NOT_FOUND_EXCEPTION);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//依次遍历handlerMapping集合进行请求处理</span></span><br><span class="line">		<span class="keyword">return</span> Flux.fromIterable(<span class="keyword">this</span>.handlerMappings)</span><br><span class="line">				.concatMap(mapping -&gt;</span><br><span class="line">				<span class="comment">//通过mapping获取mapping对应的handler</span></span><br><span class="line">				mapping.getHandler(exchange))</span><br><span class="line">				.next()</span><br><span class="line">				.switchIfEmpty(Mono.error(HANDLER_NOT_FOUND_EXCEPTION))</span><br><span class="line">				.flatMap(handler -&gt; </span><br><span class="line">				<span class="comment">//调用handler处理</span></span><br><span class="line">				invokeHandler(exchange, handler))</span><br><span class="line">				.flatMap(result -&gt; handleResult(exchange, result));</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">		<span class="function"><span class="keyword">private</span> Mono&lt;HandlerResult&gt; <span class="title">invokeHandler</span><span class="params">(ServerWebExchange exchange, Object handler)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.handlerAdapters != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">for</span> (HandlerAdapter handlerAdapter : <span class="keyword">this</span>.handlerAdapters) &#123;</span><br><span class="line">			<span class="comment">//判断当前handlerAdapter与handler是否匹配</span></span><br><span class="line">				<span class="keyword">if</span> (handlerAdapter.supports(handler)) &#123;</span><br><span class="line">					<span class="keyword">return</span> handlerAdapter.handle(exchange, handler);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> Mono.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"No HandlerAdapter: "</span> + handler));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>DispatcherHandler的handler执行顺序</p>
<ul>
<li>校验handlerMapping</li>
<li>遍历Mapping获取mapping对应的handler(此处会找到gateway对应的 RoutePredicateHandlerMapping，并通过 RoutePredicateHandlerMapping获取handler（FilteringWebHandler）)</li>
<li>通过handler对应的HandlerAdapter对handler进行调用（gateway使用的 SimpleHandlerAdapter） 即 FilteringWebHandler与SimpleHandlerAdapter对应</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.web.reactive.result.SimpleHandlerAdapter</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;HandlerResult&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange, Object handler)</span> </span>&#123;</span><br><span class="line">		WebHandler webHandler = (WebHandler) handler;</span><br><span class="line">		<span class="comment">//调用handler的handle方法处理请求</span></span><br><span class="line">		Mono&lt;Void&gt; mono = webHandler.handle(exchange);</span><br><span class="line">		<span class="keyword">return</span> mono.then(Mono.empty());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>RoutePredicateHandlerMapping</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoutePredicateHandlerMapping</span> <span class="keyword">extends</span> <span class="title">AbstractHandlerMapping</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> FilteringWebHandler webHandler;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> RouteLocator routeLocator;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">RoutePredicateHandlerMapping</span><span class="params">(FilteringWebHandler webHandler, RouteLocator routeLocator)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.webHandler = webHandler;</span><br><span class="line">		<span class="keyword">this</span>.routeLocator = routeLocator;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置排序字段1，此处的目的是Spring Cloud Gateway 的 GatewayWebfluxEndpoint 提供 HTTP API ，不需要经过网关</span></span><br><span class="line">        <span class="comment">//它通过 RequestMappingHandlerMapping 进行请求匹配处理。RequestMappingHandlerMapping 的 order = 0 ，需要排在 RoutePredicateHandlerMapping 前面。所有，RoutePredicateHandlerMapping 设置 order = 1 。</span></span><br><span class="line">		setOrder(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> Mono&lt;?&gt; getHandlerInternal(ServerWebExchange exchange) &#123;</span><br><span class="line">		<span class="comment">//设置mapping到上下文环境</span></span><br><span class="line">		exchange.getAttributes().put(GATEWAY_HANDLER_MAPPER_ATTR, getClass().getSimpleName());</span><br><span class="line"></span><br><span class="line">		<span class="comment">//查找路由</span></span><br><span class="line">		<span class="keyword">return</span> lookupRoute(exchange)</span><br><span class="line">				<span class="comment">// .log("route-predicate-handler-mapping", Level.FINER) //name this</span></span><br><span class="line">				.flatMap((Function&lt;Route, Mono&lt;?&gt;&gt;) r -&gt; &#123;</span><br><span class="line">					exchange.getAttributes().remove(GATEWAY_PREDICATE_ROUTE_ATTR);</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Mapping ["</span> + getExchangeDesc(exchange) + <span class="string">"] to "</span> + r);</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="comment">//将找到的路由信息设置到上下文环境中</span></span><br><span class="line">					exchange.getAttributes().put(GATEWAY_ROUTE_ATTR, r);</span><br><span class="line">					<span class="comment">//返回mapping对应的WebHandler即FilteringWebHandler</span></span><br><span class="line">					<span class="keyword">return</span> Mono.just(webHandler);</span><br><span class="line">				&#125;).switchIfEmpty(Mono.empty().then(Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">					<span class="comment">//当前未找到路由时返回空，并移除GATEWAY_PREDICATE_ROUTE_ATTR</span></span><br><span class="line">					exchange.getAttributes().remove(GATEWAY_PREDICATE_ROUTE_ATTR);</span><br><span class="line">					<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span><br><span class="line">						logger.trace(<span class="string">"No RouteDefinition found for ["</span> + getExchangeDesc(exchange) + <span class="string">"]"</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;)));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> Mono&lt;Route&gt; <span class="title">lookupRoute</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//通过路由定位器获取路由信息</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.routeLocator.getRoutes()</span><br><span class="line">				.filter(route -&gt; &#123;</span><br><span class="line">					<span class="comment">// add the current route we are testing</span></span><br><span class="line">					exchange.getAttributes().put(GATEWAY_PREDICATE_ROUTE_ATTR, route.getId());</span><br><span class="line">					<span class="comment">//返回通过谓语过滤的路由信息</span></span><br><span class="line">					<span class="keyword">return</span> route.getPredicate().test(exchange);</span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="comment">// .defaultIfEmpty() put a static Route not found</span></span><br><span class="line">				<span class="comment">// or .switchIfEmpty()</span></span><br><span class="line">				<span class="comment">// .switchIfEmpty(Mono.&lt;Route&gt;empty().log("noroute"))</span></span><br><span class="line">				.next()</span><br><span class="line">				<span class="comment">//<span class="doctag">TODO:</span> error handling</span></span><br><span class="line">				.map(route -&gt; &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">"Route matched: "</span> + route.getId());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="comment">//校验路由，目前空实现</span></span><br><span class="line">					validateRoute(route, exchange);</span><br><span class="line">					<span class="keyword">return</span> route;</span><br><span class="line">				&#125;);</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>RoutePredicateHandlerMapping的执行顺序</p>
<ul>
<li>通过路由定位器获取全部路由（RouteLocator）</li>
<li>通过路由的谓语（Predicate）过滤掉不可用的路由信息</li>
<li>查找到路由信息后将路由信息设置当上下文环境中（GATEWAY_ROUTE_ATTR）</li>
<li>返回gatway自定的webhandler（FilteringWebHandler）</li>
</ul>
</blockquote>
<blockquote>
<p>备注：<br>在构建方法中看到setOrder(1);作用：Spring Cloud Gateway 的 GatewayWebfluxEndpoint 提供 HTTP API ，不需要经过网关。<br>        通过 RequestMappingHandlerMapping 进行请求匹配处理。RequestMappingHandlerMapping 的 order = 0 ，需要排在 RoutePredicateHandlerMapping 前面，所以设置 order = 1 。</p>
</blockquote>
<ol start="3">
<li>FilteringWebHandler</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过过滤器处理web请求的处理器</span></span><br><span class="line"><span class="comment"> * WebHandler that delegates to a chain of &#123;<span class="doctag">@link</span> GlobalFilter&#125; instances and</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> GatewayFilterFactory&#125; instances then to the target &#123;<span class="doctag">@link</span> WebHandler&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Rossen Stoyanchev</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 0.1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FilteringWebHandler</span> <span class="keyword">implements</span> <span class="title">WebHandler</span> </span>&#123;</span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(FilteringWebHandler.class);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 全局过滤器</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;GatewayFilter&gt; globalFilters;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">FilteringWebHandler</span><span class="params">(List&lt;GlobalFilter&gt; globalFilters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.globalFilters = loadFilters(globalFilters);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 包装加载全局的过滤器，将全局过滤器包装成GatewayFilter</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> filters</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;GatewayFilter&gt; <span class="title">loadFilters</span><span class="params">(List&lt;GlobalFilter&gt; filters)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> filters.stream()</span><br><span class="line">				.map(filter -&gt; &#123;</span><br><span class="line">					<span class="comment">//将所有的全局过滤器包装成网关过滤器</span></span><br><span class="line">					GatewayFilterAdapter gatewayFilter = <span class="keyword">new</span> GatewayFilterAdapter(filter);</span><br><span class="line">					<span class="comment">//判断全局过滤器是否实现了可排序接口</span></span><br><span class="line">					<span class="keyword">if</span> (filter <span class="keyword">instanceof</span> Ordered) &#123;</span><br><span class="line">						<span class="keyword">int</span> order = ((Ordered) filter).getOrder();</span><br><span class="line">						<span class="comment">//包装成可排序的网关过滤器</span></span><br><span class="line">						<span class="keyword">return</span> <span class="keyword">new</span> OrderedGatewayFilter(gatewayFilter, order);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> gatewayFilter;</span><br><span class="line">				&#125;).collect(Collectors.toList());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//获取请求上下文设置的路由实例</span></span><br><span class="line">		Route route = exchange.getRequiredAttribute(GATEWAY_ROUTE_ATTR);</span><br><span class="line">		<span class="comment">//获取路由定义下的网关过滤器集合</span></span><br><span class="line">		List&lt;GatewayFilter&gt; gatewayFilters = route.getFilters();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//组合全局的过滤器与路由配置的过滤器</span></span><br><span class="line">		List&lt;GatewayFilter&gt; combined = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.globalFilters);</span><br><span class="line">		<span class="comment">//添加路由配置过滤器到集合尾部</span></span><br><span class="line">		combined.addAll(gatewayFilters);</span><br><span class="line">		<span class="comment">//对过滤器进行排序</span></span><br><span class="line">		<span class="comment">//<span class="doctag">TODO:</span> needed or cached?</span></span><br><span class="line">		AnnotationAwareOrderComparator.sort(combined);</span><br><span class="line"></span><br><span class="line">		logger.debug(<span class="string">"Sorted gatewayFilterFactories: "</span>+ combined);</span><br><span class="line">		<span class="comment">//创建过滤器链表对其进行链式调用</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> DefaultGatewayFilterChain(combined).filter(exchange);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>FilteringWebHandler的执行顺序</p>
<ul>
<li>构建一个包含全局过滤器的集合（combined）</li>
<li>获取上下中的路由信息GATEWAY_ROUTE_ATTR</li>
<li>将路由里的过滤器添加到集合中（combined）</li>
<li>对过滤器集合进行排序操作</li>
<li>通过过滤器集合组装过滤器链表，并进行调用（DefaultGatewayFilterChain与Servlet中的FilterChain与原理是一致的）</li>
<li>通过过滤器来处理请求到具体业务服务</li>
</ul>
</blockquote>
<hr>
<p>整个代码阅读下来，使得对Spring-Cloud-Gateway的工作原理清晰明了的理解。</p>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud-Gateway/">Spring-Cloud-Gateway</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">6</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Eureka/" style="font-size: 10px;">Eureka</a> <a href="/tags/微服务/" style="font-size: 20px;">微服务</a> <a href="/tags/网关/" style="font-size: 10px;">网关</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Spring-Cloud-Gateway之配置路由过滤器/">Spring-Cloud-Gateway之配置路由过滤器</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Spring-Cloud-Gateway之RoutePredicate/">Spring-Cloud-Gateway之RoutePredicate</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Spring-Cloud-Gateway初始化/">Spring-Cloud-Gateway初始化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Eureka-Server之注册服务实例租约信息管理LeaseManager/">Eureka Server之注册服务实例租约信息管理LeaseManager</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/03/Spring-Cloud-Gateway之GatewayProperties初始化加载/">Spring-Cloud-Gateway之GatewayProperties初始化加载</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/09/03/Spring-Cloud-Gateway之route数据模型/" class="prev">上一篇</a><a href="/2018/08/28/Eureka之服务发现LookupService/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="#" target="_blank">Mr.G</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>陕ICP备16007301</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>