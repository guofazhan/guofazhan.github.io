<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Spring-Cloud-Gateway之RoutePredicate · Mr.G-博客</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Spring-Cloud-Gateway之RoutePredicate - Mr.G"><meta name="keywords"><meta name="author" content="Mr.G"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="https://guofazhan.github.io/atom.xml" title="Mr.G-博客"></head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Spring-Cloud-Gateway之RoutePredicate</h1><div class="post-info">2018-09-03<!-- p.visit--><!--    if (is_home())--><!--        i(data-hk-page='http://bubuzou.com'+url_for(item.path)) ---><!--    else--><!--        i(data-hk-page="current") ---><!--   span 次访问--></div><div class="post-content"><p>Spring-Cloud-Gateway路由选择是通过Predicate函数式接口进行判断当前路由是否满足给定条件。下来阅读Spring-Cloud-Gateway路由的Predicate构建流程以及选择路由的源码</p>
<hr>
<a id="more"></a>
<p>首先看下JDK8中Predicate接口定义</p>
<blockquote>
<p>Predicate<t> 接受一个输入参数，返回一个布尔值结果。该接口包含多种默认方法来将Predicate组合成其他复杂的逻辑（比如：与，或，非）。可以用于接口请求参数校验、判断新老数据是否有变化需要进行更新操作。add–与、or–或、negate–非</t></p>
<ul>
<li>boolean test(T t); 判断</li>
<li>Predicate<t> and(Predicate&lt;? super T&gt; other) 接收一个Predicate类型，也就是将传入的条件和当前条件以并且(AND)的关系组合</t></li>
<li>Predicate<t> or(Predicate&lt;? super T&gt; other)接收一个Predicate类型，也就是将传入的条件和当前条件以或(OR)的关系组合 </t></li>
</ul>
</blockquote>
<hr>
<ol>
<li>加载路由中的Predicate<blockquote>
<p>在路由定位器中以及看到了通过路由定义转换路由方法，其中包含了通过谓语定义(PredicateDefinition)转换谓语(Predicate)的部分,在RouteDefinitionRouteLocator类中源码如下：</p>
</blockquote>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回组合的谓词</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> routeDefinition</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Predicate&lt;ServerWebExchange&gt; <span class="title">combinePredicates</span><span class="params">(RouteDefinition routeDefinition)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//获取RouteDefinition中的PredicateDefinition集合</span></span><br><span class="line">	List&lt;PredicateDefinition&gt; predicates = routeDefinition.getPredicates();</span><br><span class="line"></span><br><span class="line">	Predicate&lt;ServerWebExchange&gt; predicate = lookup(routeDefinition, predicates.get(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (PredicateDefinition andPredicate : predicates.subList(<span class="number">1</span>, predicates.size())) &#123;</span><br><span class="line">		Predicate&lt;ServerWebExchange&gt; found = lookup(routeDefinition, andPredicate);</span><br><span class="line">		<span class="comment">//返回一个组合的谓词，表示该谓词与另一个谓词的短路逻辑AND</span></span><br><span class="line">		predicate = predicate.and(found);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> predicate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取一个谓语定义（PredicateDefinition）转换的谓语</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> route</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> predicate</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> Predicate&lt;ServerWebExchange&gt; <span class="title">lookup</span><span class="params">(RouteDefinition route, PredicateDefinition predicate)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//获取谓语创建工厂</span></span><br><span class="line">	RoutePredicateFactory&lt;Object&gt; factory = <span class="keyword">this</span>.predicates.get(predicate.getName());</span><br><span class="line">	<span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to find RoutePredicateFactory with name "</span> + predicate.getName());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//获取参数</span></span><br><span class="line">	Map&lt;String, String&gt; args = predicate.getArgs();</span><br><span class="line">	<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">		logger.debug(<span class="string">"RouteDefinition "</span> + route.getId() + <span class="string">" applying "</span></span><br><span class="line">				+ args + <span class="string">" to "</span> + predicate.getName());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//组装参数</span></span><br><span class="line">       Map&lt;String, Object&gt; properties = factory.shortcutType().normalize(args, factory, <span class="keyword">this</span>.parser, <span class="keyword">this</span>.beanFactory);</span><br><span class="line">       <span class="comment">//构建创建谓语的配置信息</span></span><br><span class="line">	Object config = factory.newConfig();</span><br><span class="line">       ConfigurationUtils.bind(config, properties,</span><br><span class="line">               factory.shortcutFieldPrefix(), predicate.getName(), validator);</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.publisher != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.publisher.publishEvent(<span class="keyword">new</span> PredicateArgsEvent(<span class="keyword">this</span>, route.getId(), properties));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//通过谓语工厂构建谓语</span></span><br><span class="line">       <span class="keyword">return</span> factory.apply(config);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>获取路由定义（routeDefinition）所有的谓语定位（PredicateDefinition）</li>
<li>以此根据谓语定义（PredicateDefinition）查找谓语对于的创建工厂（RoutePredicateFactory） 创建谓语</li>
<li>通过 Predicate<t>接口 and方法合并谓语集合返回一个新的复合谓语</t></li>
</ol>
</blockquote>
<ol start="2">
<li>使用路由Predicate判断路由是否可用<blockquote>
<p>在Spring-Cloud-Gateway之请求处理流程里我们已经了解在handlerMapping中通过路由定位器获取所有路由，并过滤掉谓语判断失败的路由，最终获取满足条件的路由，下面再看下过滤的具体逻辑。</p>
</blockquote>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Mono&lt;Route&gt; <span class="title">lookupRoute</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//通过路由定位器获取路由信息</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.routeLocator.getRoutes()</span><br><span class="line">				.filter(route -&gt; &#123;</span><br><span class="line">			exchange.getAttributes().put(GATEWAY_PREDICATE_ROUTE_ATTR, route.getId());</span><br><span class="line">					<span class="comment">//返回通过谓语过滤的路由信息</span></span><br><span class="line">					<span class="keyword">return</span> route.getPredicate().test(exchange);</span><br><span class="line">				&#125;)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>通过routeLocator的getRoutes方法获取所有路由</li>
<li>在所有路由中通过filter方法匹配Predicate.test匹配的路由信息</li>
</ol>
</blockquote>
<hr>
<p>通过上面1，2两步我们看到了整个路由的条件创建以及使用的地方以及流程，Spring-Cloud-Gateway通过Predicate接口完成简单条件组合以及判断。</p>
<blockquote>
<p>接下来看通过RoutePredicateFactory创建PredicateSpring-Cloud-Gateway预制了很多RoutePredicateFactory使其可以通过简单的配置就可以创建出理想的Predicate</p>
</blockquote>
<p>RoutePredicateFactory类图如下：<br><img src="https://raw.githubusercontent.com/guofazhan/image/master/RoutePredicateFactoryUML.png" alt="image"><br>RoutePredicateFactory子类功能分类图：<br><img src="https://raw.githubusercontent.com/guofazhan/image/master/PredicateFactory.png" alt="image"></p>
<hr>
<ul>
<li>MethodRoutePredicateFactory</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 请求方式（GET,POST,DEL,PUT）校验匹配创建工厂</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Spencer Gibb</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">MethodRoutePredicateFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String METHOD_KEY = <span class="string">"method"</span>;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> exchange -&gt; &#123;</span><br><span class="line">			<span class="comment">//获取当前请求的HttpMethod</span></span><br><span class="line">			HttpMethod requestMethod = exchange.getRequest().getMethod();</span><br><span class="line">			<span class="comment">//校验请求HttpMethod与配置是否一致</span></span><br><span class="line">			<span class="keyword">return</span> requestMethod == config.getMethod();</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * http 请求Method</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">private</span> HttpMethod method;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> HttpMethod <span class="title">getMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> method;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMethod</span><span class="params">(HttpMethod method)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.method = method;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 配置列子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cloud:</span><br><span class="line">    gateway:</span><br><span class="line">      routes:</span><br><span class="line">      # =====================================</span><br><span class="line">      - id: method_route</span><br><span class="line">        uri: http:<span class="comment">//example.org</span></span><br><span class="line">        predicates:</span><br><span class="line">        - Method=GET</span><br></pre></td></tr></table></figure>
<blockquote>
<ol>
<li>Method=GET 会被解析成PredicateDefinition对象 （name =Method ，args= GET）</li>
<li>通过PredicateDefinition的Name找到MethodRoutePredicateFactory工厂</li>
<li>通过 PredicateDefinition 的args 创建Config对象（HttpMethod=GET）</li>
<li>通过 MethodRoutePredicateFactory工厂的apply方法传入config创建Predicate对象。</li>
</ol>
</blockquote>
<blockquote>
<p>在此只对MethodRoutePredicateFactory做了描述和说明，其它的谓语工程基本与此一致。此时Spring-Cloud-Gateway的RoutePredicate所有逻辑代码都已经阅读完毕，对阅读过程做文档记录以便加深印象，后期翻阅</p>
</blockquote>
</div></article></div><div class="right-container"><div class="widget"><div class="category"><h4>分类归档</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Cloud-Gateway/">Spring-Cloud-Gateway</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a><span class="category-list-count">7</span></li></ul></div></div><div class="widget"><div class="tagcloud"><h4>标签云</h4><a href="/tags/Eureka/" style="font-size: 16.67px;">Eureka</a> <a href="/tags/Hystrix/" style="font-size: 10px;">Hystrix</a> <a href="/tags/微服务/" style="font-size: 20px;">微服务</a> <a href="/tags/网关/" style="font-size: 13.33px;">网关</a></div></div><div class="widget"><div class="recent"><h4>最近文章</h4><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/zuul之过滤器Filter管理/">zuul之过滤器Filter管理</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/Spring-Cloud-Gateway之请求处理流程/">zuul之动态过滤器Filter类文件管理加载</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/23/zuul之请求处理流程/">zuul之请求处理流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/11/Hystrix之信号量隔离熔断/">Hystrix之信号量隔离熔断</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/Spring-Cloud-Gateway之配置路由过滤器/">Spring-Cloud-Gateway之配置路由过滤器</a></li></ul></div></div><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2018/09/04/Spring-Cloud-Gateway之配置路由过滤器/" class="prev">上一篇</a><a href="/2018/09/04/Spring-Cloud-Gateway初始化/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="#" target="_blank">Mr.G</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p>陕ICP备16007301</p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="http://apps.bdimg.com/libs/jquery/1.8.2/jquery.min.js"></script><script src="https://cdn1.lncld.net/static/js/av-mini-0.6.10.js"></script><script src="/scripts/hit-kounter-lc-0.2.0.js"></script><script src="/scripts/arAnchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>